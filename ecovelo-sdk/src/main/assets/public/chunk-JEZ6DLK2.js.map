{
  "version": 3,
  "sources": ["src/app/components/modals/news-detail/news-detail.component.ts", "src/app/components/modals/news-detail/news-detail.component.html", "src/app/services/api-wrappers/news.service.ts"],
  "sourcesContent": ["import { Component, Input, OnInit } from '@angular/core'\nimport { ListNew200ResponseAllOfDataInner } from 'src/api-cyclist'\nimport { ModalController } from '@ionic/angular/standalone'\nimport { IonicModule } from '@ionic/angular'\nimport { CommonModule } from '@angular/common'\nimport { addIcons } from 'ionicons'\nimport { arrowBack } from 'ionicons/icons'\nimport * as Showdown from 'showdown'\n\n@Component({\n    selector: 'app-news-detail',\n    templateUrl: './news-detail.component.html',\n    styleUrls: ['./news-detail.component.scss'],\n    imports: [IonicModule, CommonModule]\n})\nexport class NewsDetailComponent {\n  @Input() news: ListNew200ResponseAllOfDataInner\n\n  constructor(private modalCtrl: ModalController) {\n    addIcons({ arrowBack })\n  }\n  cancel() {\n    this.modalCtrl.dismiss()\n  }\n\n  showdown(text: string) {\n    const converter = new Showdown.Converter()\n    return converter.makeHtml(text)\n  }\n}\n", "@if (news) {\n<ion-content>\n  <ion-button (click)=\"cancel()\" shape=\"round\" color=\"light\">\n    <ion-icon slot=\"icon-only\" name=\"arrow-back\"></ion-icon>\n  </ion-button>\n  <ion-img *ngIf=\"news.image\" [src]=\"news.image\" alt=\"News image\"></ion-img>\n  <div\n    class=\"ion-padding ion-margin-bottom\"\n    [ngClass]=\"{ 'no-image': !news.image }\"\n  >\n    <h1\n      [innerHTML]=\"showdown(news.title || '')\"\n      class=\"ion-no-margin ion-margin-bottom ion-margin-top\"\n    ></h1>\n    <div [innerHTML]=\"showdown(news.text || '')\"></div>\n  </div>\n</ion-content>\n}\n", "import { EventEmitter, Injectable, signal } from '@angular/core'\nimport { BehaviorSubject, Observable } from 'rxjs'\nimport {\n  ListNew200Response,\n  ListNew200ResponseAllOfDataInner,\n} from 'src/api-cyclist'\nimport { ModalController } from '@ionic/angular/standalone'\nimport { NewsDetailComponent } from '../../components/modals/news-detail/news-detail.component'\nimport { StorageService } from '../utils/storage.service'\nimport { NewsService } from 'src/api-cyclist'\nimport { environment } from 'src/environments/environment'\nimport * as Showdown from 'showdown'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\n\nexport type NewsState =\n  | { state: 'loading' }\n  | { state: 'success'; news: ListNew200ResponseAllOfDataInner[] }\n  | { state: 'no_news' }\n  | { state: 'error'; error: Error }\n\nexport type MandatoryNewsState = {\n  state: 'not_shown' | 'shown'\n  lastShownTimestamp?: number\n  lastShown?: ListNew200ResponseAllOfDataInner\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class NewsStateService {\n  private state = new BehaviorSubject<NewsState>({ state: 'no_news' })\n  public mandatoryState = signal<MandatoryNewsState>({ state: 'not_shown' })\n  public mandatoryDismissed = new EventEmitter<void>()\n  private converter: Showdown.Converter\n\n  constructor(\n    private modalCtrl: ModalController,\n    private storageService: StorageService,\n    private newsService: NewsService,\n    private errorHandler: ErrorHandlerService\n  ) {\n    this.initMandatoryState()\n    this.converter = new Showdown.Converter()\n  }\n\n  // Initialize mandatory state from storage\n  private async initMandatoryState(): Promise<void> {\n    try {\n      const storedState = await this.storageService.get('mandatory')\n      if (storedState) {\n        this.mandatoryState.set(storedState)\n      }\n    } catch (error) {\n      this.errorHandler.handleError(error)\n    }\n  }\n\n  // Save mandatory state to storage\n  public async saveMandatoryState(): Promise<void> {\n    try {\n      await this.storageService.set('mandatory', this.mandatoryState())\n    } catch (error) {\n      this.errorHandler.handleError(error)\n    }\n  }\n\n  getState(): Observable<NewsState> {\n    return this.state.asObservable()\n  }\n\n  async retrieveNews(): Promise<void> {\n    this.state.next({ state: 'loading' })\n    this.newsService\n      .listNew({\n        program: environment.program,\n        program2: environment.program,\n        status: 'active',\n        limit: 100,\n      })\n      .subscribe(\n        async (news: ListNew200Response) => {\n          // Convertir le markdown en HTML pour chaque news\n          if (news.data) {\n            news.data = news.data.map((item) => ({\n              ...item,\n              title: item.title\n                ? this.converter.makeHtml(item.title)\n                : item.title,\n              text: item.text ? this.converter.makeHtml(item.text) : item.text,\n            }))\n          }\n\n          await this.storageService.set('news', news)\n\n          // Check if there's a mandatory news and update state accordingly\n          const mandatoryNews = news.data?.find(\n            (news) => news.priority === 'highlighted'\n          )\n          if (mandatoryNews && mandatoryNews.id) {\n            await this.updateMandatory(mandatoryNews)\n          }\n\n          if (!news?.data || news.data.length === 0) {\n            this.state.next({ state: 'no_news' })\n            return\n          }\n\n          this.state.next({ state: 'success', news: news.data })\n        },\n        (error: Error) => {\n          this.errorHandler.handleError(error)\n          this.state.next({\n            state: 'error',\n            error: error instanceof Error ? error : new Error('Unknown error'),\n          })\n        }\n      )\n  }\n\n  private async updateMandatory(\n    newMandatory: ListNew200ResponseAllOfDataInner\n  ): Promise<void> {\n    const now = Date.now()\n    //Reset mandatory conditions\n    if (\n      !this.mandatoryState().state ||\n      (this.mandatoryState().state === 'shown' &&\n        this.mandatoryState().lastShown?.id !== newMandatory.id) ||\n      (this.mandatoryState().state === 'shown' &&\n        this.mandatoryState().lastShownTimestamp &&\n        now - this.mandatoryState().lastShownTimestamp! >= 1000 * 60 * 60 * 24)\n    ) {\n      this.mandatoryState.set({ state: 'not_shown' })\n    }\n    // Save state to storage after updating\n    await this.saveMandatoryState()\n  }\n\n  getNews(): ListNew200ResponseAllOfDataInner[] | undefined {\n    const currentState = this.state.value\n    return currentState.state === 'success' ? currentState.news : undefined\n  }\n\n  async getMandatory(): Promise<ListNew200ResponseAllOfDataInner | undefined> {\n    const currentState = this.state.value\n    if (currentState.state !== 'success') return\n    return currentState.news.find((news) => news.priority === 'highlighted')\n  }\n\n  async openDetail(\n    news: ListNew200ResponseAllOfDataInner,\n    type: 'mandatory' | 'news'\n  ): Promise<void> {\n    const modal = await this.modalCtrl.create({\n      component: NewsDetailComponent,\n      componentProps: {\n        news: news,\n      },\n      initialBreakpoint: 1,\n    })\n    await modal.present()\n\n    await modal.onDidDismiss().then(async () => {\n      if (type === 'mandatory') {\n        // Update state to shown with timestamp and ID after dismissal\n        this.mandatoryState.set({\n          state: 'shown',\n          lastShownTimestamp: Date.now(),\n          lastShown: news,\n        })\n\n        // Save state to storage after updating\n        await this.saveMandatoryState()\n\n        // Emit event when mandatory news is dismissed\n        this.mandatoryDismissed.emit()\n      }\n    })\n  }\n}\n"],
  "mappings": "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",
  "names": ["Showdown", "news"]
}
