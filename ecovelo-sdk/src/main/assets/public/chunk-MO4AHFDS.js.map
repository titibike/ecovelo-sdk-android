{
  "version": 3,
  "sources": ["src/app/services/external/stripe.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core'\nimport { StripeServiceInterface, injectStripe } from 'ngx-stripe'\nimport { SetupIntentResult, StripeElementsOptions } from '@stripe/stripe-js'\nimport { environment } from 'src/environments/environment'\nimport { CardsService } from 'src/api-cyclist'\nimport { Observable, map, throwError, from } from 'rxjs'\nimport { catchError, switchMap, tap } from 'rxjs/operators'\nimport { LoadingController } from '@ionic/angular/standalone'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\nimport { Stripe } from '@capacitor-community/stripe'\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class StripeService {\n  private stripe: StripeServiceInterface = injectStripe(\n    environment.stripePublicKey\n  )\n\n  constructor(\n    private cardService: CardsService,\n    private loadingCtrl: LoadingController,\n    private errorHandler: ErrorHandlerService\n  ) {}\n\n  getStripe(): StripeServiceInterface {\n    return this.stripe\n  }\n\n  initStripeElements(programId: string): Observable<StripeElementsOptions> {\n    return this.cardService\n      .createSetupIntent({\n        program: programId,\n        liveMode: environment.production,\n      })\n      .pipe(\n        map((res) => {\n          if (res.client_secret) {\n            return {\n              locale: 'fr',\n              clientSecret: res.client_secret,\n              appearance: {\n                theme: 'stripe',\n              },\n            } as StripeElementsOptions\n          } else throw new Error('Client secret required')\n        }),\n        catchError((error) => {\n          this.errorHandler.handleError(error)\n          return throwError(() => error)\n        })\n      )\n  }\n\n  confirmSetup(\n    elements: any,\n    clientSecret: string,\n    holderName: string\n  ): Observable<SetupIntentResult> {\n    // Submit elements for validation\n    return from(elements.submit()).pipe(\n      // Chain with Stripe confirmation\n      switchMap(() =>\n        this.stripe.confirmSetup({\n          elements,\n          clientSecret,\n          confirmParams: {\n            payment_method_data: {\n              billing_details: {\n                name: holderName,\n              },\n            },\n            return_url: location.href,\n          },\n        })\n      ),\n      // Handle successful result\n      tap((result: SetupIntentResult) => {\n        if (result.error) {\n          throw result.error\n        }\n        // Si pas d'erreur, on a forcÃ©ment un setupIntent\n        if (result.setupIntent?.status === 'succeeded') {\n          window.location.href = location.href\n        }\n      }),\n      // Handle errors\n      catchError((error: any) => {\n        this.errorHandler.handleError(error)\n        return throwError(() => error)\n      })\n    )\n  }\n\n  retrieveSetupIntent(\n    clientSecret: string\n  ): Observable<SetupIntentResult | null> {\n    return this.stripe.retrieveSetupIntent(clientSecret).pipe(\n      map((result) => result ?? null),\n      catchError((error: any) => {\n        this.errorHandler.handleError(error)\n        return throwError(() => error)\n      })\n    )\n  }\n\n  /**\n   * Setup and process Apple Pay payment\n   */\n  async setupApplePay(\n    clientSecret: string,\n    programName: string,\n    merchantId: string\n  ): Promise<'completed' | 'failed' | 'cancelled'> {\n    try {\n      if (!clientSecret) {\n        this.errorHandler.handleError(new Error('Client secret required'))\n        throw new Error('Client secret required')\n      }\n\n      // Create Apple Pay\n      await Stripe.createApplePay({\n        paymentIntentClientSecret: clientSecret,\n        paymentSummaryItems: [\n          {\n            label: programName || 'Paiement',\n            amount: 0,\n          },\n        ],\n        merchantIdentifier: merchantId,\n        countryCode: 'FR',\n        currency: 'EUR',\n      })\n\n      // Present Apple Pay\n      const result = await Stripe.presentApplePay()\n\n      if (result.paymentResult === 'applePayCompleted') {\n        return 'completed'\n      } else if (result.paymentResult === 'applePayFailed') {\n        this.errorHandler.handleError(new Error('Apple pay payment failed'))\n        return 'failed'\n      } else {\n        // Cancelled by user\n        return 'cancelled'\n      }\n    } catch (error: any) {\n      this.errorHandler.handleError(error)\n      throw error\n    }\n  }\n\n  /**\n   * Setup and process Google Pay payment\n   */\n  async setupGooglePay(\n    clientSecret: string,\n    programName: string\n  ): Promise<'completed' | 'failed' | 'cancelled'> {\n    try {\n      if (!clientSecret) {\n        this.errorHandler.handleError(new Error('Client secret required'))\n        throw new Error('Client secret required')\n      }\n\n      await Stripe.createPaymentSheet({\n        setupIntentClientSecret: clientSecret,\n        enableGooglePay: true,\n        merchantDisplayName: programName || 'Ecovelo',\n        countryCode: 'FR',\n        currencyCode: 'EUR',\n      })\n\n      // Present Google Pay\n      const result = await Stripe.presentPaymentSheet()\n\n      if (result.paymentResult === 'paymentSheetCompleted') {\n        return 'completed'\n      } else if (result.paymentResult === 'paymentSheetFailed') {\n        this.errorHandler.handleError(new Error('Google pay payment failed'))\n        return 'failed'\n      } else {\n        // Cancelled by user\n        return 'cancelled'\n      }\n    } catch (error: any) {\n      this.errorHandler.handleError(error)\n      throw error\n    }\n  }\n\n  /**\n   * Check if Apple Pay is available on this device\n   */\n  async isApplePayAvailable(): Promise<boolean> {\n    try {\n      await Stripe.isApplePayAvailable()\n      return true\n    } catch {\n      return false\n    }\n  }\n\n  /**\n   * Check if Google Pay is available on this device\n   */\n  async isGooglePayAvailable(): Promise<boolean> {\n    try {\n      await Stripe.isGooglePayAvailable()\n      return true\n    } catch {\n      return false\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
