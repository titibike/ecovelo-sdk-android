{
  "version": 3,
  "sources": ["src/app/services/api-wrappers/cgu.service.ts"],
  "sourcesContent": ["import { effect, Injectable } from '@angular/core'\nimport { BehaviorSubject } from 'rxjs'\nimport {\n  RegistrationsService,\n  RetrieveTerms200Response,\n  TermsService,\n} from 'src/api-cyclist'\nimport { environment } from 'src/environments/environment'\nimport { DomSanitizer, SafeHtml } from '@angular/platform-browser'\nimport * as showdown from 'showdown'\nimport { AccountService } from './account.service'\nimport { ToastService, ToastType } from '../utils/toast.service'\nimport { TranslateService } from '@ngx-translate/core'\nimport { LoadingController } from '@ionic/angular'\nimport { LanguageService } from '../utils/language.service'\n\nexport type cguLoadingState =\n  | { state: 'loading' }\n  | { state: 'no_data' }\n  | {\n      state: 'success'\n      cgu: RetrieveTerms200Response\n      terms: SafeHtml\n    }\n  | { state: 'error'; error: Error }\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class CguService {\n  cguLoadingState = new BehaviorSubject<cguLoadingState>({\n    state: 'loading',\n  })\n\n  private language: string = 'fr'\n  private converter: showdown.Converter\n  constructor(\n    private termsService: TermsService,\n    private sanitizer: DomSanitizer,\n    private registrationsService: RegistrationsService,\n    private toastService: ToastService,\n    private translateService: TranslateService,\n    private loadingCtrl: LoadingController,\n    private languageService: LanguageService,\n    private accountService: AccountService\n  ) {\n    this.converter = new showdown.Converter()\n    effect(() => {\n      this.language = this.languageService.currentLanguage()\n      this.getCgu()\n    })\n  }\n\n  async getCgu() {\n    this.cguLoadingState.next({ state: 'loading' })\n    this.termsService\n      .retrieveTerms({ program: environment.program, language: this.language })\n      .subscribe({\n        next: async (response) => {\n          if (response.text) {\n            this.cguLoadingState.next({\n              state: 'success',\n              cgu: response,\n              terms: this.sanitizer.bypassSecurityTrustHtml(\n                this.converter.makeHtml(response.text)\n              ),\n            })\n          }\n        },\n        error: (error) => {\n          this.cguLoadingState.next({ state: 'error', error })\n        },\n      })\n  }\n\n  async validateTerms(): Promise<void> {\n    return new Promise(async (resolve, reject) => {\n      this.registrationsService\n        .updateRegistration({\n          program: environment.program,\n          body: {\n            terms_validated: true,\n          },\n        })\n        .subscribe({\n          next: async () => {\n            const currentCyclist = this.accountService.getCurrentCyclist()\n\n            this.accountService.updateCyclistData({\n              ...currentCyclist,\n              registrations: {\n                ...currentCyclist.registrations,\n                data: [\n                  {\n                    ...currentCyclist.registrations?.data?.[0],\n                    terms_validated: true,\n                    terms_validated_at: Date.now(),\n                  },\n                ],\n              },\n            })\n            resolve()\n          },\n          error: (error) => {\n            this.toastService.createWithJustMessage(\n              error.error.message,\n              ToastType.Error\n            )\n            reject(error)\n          },\n        })\n    })\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASA,eAA0B;AAoBpB,IAAO,cAAP,MAAO,YAAU;EAOrB,YACU,cACA,WACA,sBACA,cACA,kBACA,aACA,iBACA,gBAA8B;AAP9B,SAAA,eAAA;AACA,SAAA,YAAA;AACA,SAAA,uBAAA;AACA,SAAA,eAAA;AACA,SAAA,mBAAA;AACA,SAAA,cAAA;AACA,SAAA,kBAAA;AACA,SAAA,iBAAA;AAdV,SAAA,kBAAkB,IAAI,gBAAiC;MACrD,OAAO;KACR;AAEO,SAAA,WAAmB;AAYzB,SAAK,YAAY,IAAa,mBAAS;AACvC,WAAO,MAAK;AACV,WAAK,WAAW,KAAK,gBAAgB,gBAAe;AACpD,WAAK,OAAM;IACb,CAAC;EACH;EAEM,SAAM;;AACV,WAAK,gBAAgB,KAAK,EAAE,OAAO,UAAS,CAAE;AAC9C,WAAK,aACF,cAAc,EAAE,SAAS,YAAY,SAAS,UAAU,KAAK,SAAQ,CAAE,EACvE,UAAU;QACT,MAAM,CAAO,aAAY;AACvB,cAAI,SAAS,MAAM;AACjB,iBAAK,gBAAgB,KAAK;cACxB,OAAO;cACP,KAAK;cACL,OAAO,KAAK,UAAU,wBACpB,KAAK,UAAU,SAAS,SAAS,IAAI,CAAC;aAEzC;UACH;QACF;QACA,OAAO,CAAC,UAAS;AACf,eAAK,gBAAgB,KAAK,EAAE,OAAO,SAAS,MAAK,CAAE;QACrD;OACD;IACL;;EAEM,gBAAa;;AACjB,aAAO,IAAI,QAAQ,CAAO,SAAS,WAAU;AAC3C,aAAK,qBACF,mBAAmB;UAClB,SAAS,YAAY;UACrB,MAAM;YACJ,iBAAiB;;SAEpB,EACA,UAAU;UACT,MAAM,MAAW;AArF3B;AAsFY,kBAAM,iBAAiB,KAAK,eAAe,kBAAiB;AAE5D,iBAAK,eAAe,kBAAkB,iCACjC,iBADiC;cAEpC,eAAe,iCACV,eAAe,gBADL;gBAEb,MAAM;kBACJ,kCACK,0BAAe,kBAAf,mBAA8B,SAA9B,mBAAqC,KAD1C;oBAEE,iBAAiB;oBACjB,oBAAoB,KAAK,IAAG;;;;cAInC;AACD,oBAAO;UACT;UACA,OAAO,CAAC,UAAS;AACf,iBAAK,aAAa,sBAChB,MAAM,MAAM,SACZ,UAAU,KAAK;AAEjB,mBAAO,KAAK;UACd;SACD;MACL,EAAC;IACH;;;;mCAnFW,aAAU,mBAAA,YAAA,GAAA,mBAAA,YAAA,GAAA,mBAAA,oBAAA,GAAA,mBAAA,YAAA,GAAA,mBAAA,gBAAA,GAAA,mBAAA,iBAAA,GAAA,mBAAA,eAAA,GAAA,mBAAA,cAAA,CAAA;AAAA;+EAAV,aAAU,SAAV,YAAU,WAAA,YAFT,OAAM,CAAA;AAEd,IAAO,aAAP;;sEAAO,YAAU,CAAA;UAHtB;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
