{
  "version": 3,
  "sources": ["src/app/services/api-wrappers/facture.service.ts"],
  "sourcesContent": ["import { effect, Injectable } from '@angular/core'\nimport { BehaviorSubject, forkJoin, catchError, of } from 'rxjs'\nimport {\n  FacturesService,\n  ListFacture200ResponseAllOfDataInner,\n  UpcomingFactures200Response,\n} from 'src/api-cyclist'\nimport { environment } from 'src/environments/environment'\nimport { AuthService } from '../external/auth.service'\nimport { AccountService } from './account.service'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\n\nexport type FacturesState =\n  | {\n      state: 'loading'\n    }\n  | {\n      state: 'upcoming'\n      upcoming: UpcomingFactures200Response\n    }\n  | {\n      state: 'factures'\n      invoices: ListFacture200ResponseAllOfDataInner[]\n      dues?: ListFacture200ResponseAllOfDataInner[]\n      upcoming?: UpcomingFactures200Response\n      hasMore: boolean\n    }\n  | {\n      state: 'noInvoices'\n    }\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class FactureService {\n  factureState: BehaviorSubject<FacturesState> =\n    new BehaviorSubject<FacturesState>({\n      state: 'loading',\n    })\n\n  constructor(\n    private facturesService: FacturesService,\n    private authService: AuthService,\n    private accountService: AccountService,\n    private errorHandler: ErrorHandlerService\n  ) {\n    effect(() => {\n      if (\n        this.authService.authState().state === 'SignedIn' &&\n        this.factureState.value.state == 'loading'\n      ) {\n        this.getFactures()\n      } else if (this.authService.authState().state === 'SignedOut') {\n        this.resetState()\n      }\n    })\n  }\n\n  async getFactures() {\n    forkJoin({\n      upcoming: this.facturesService\n        .upcomingFactures({\n          program: environment.program,\n        })\n        .pipe(\n          catchError((error) => {\n            if (error.status === 404) {\n              return of(undefined)\n            }\n            this.errorHandler.handleError(error)\n            throw error\n          })\n        ),\n      factures: this.facturesService.listFacture({\n        program: environment.program,\n        limit: 30,\n      }),\n    }).subscribe(({ upcoming, factures }) => {\n      if (factures.data!.length > 0) {\n        const unpaidInvoices = factures.data!.filter(\n          (invoice) =>\n            invoice.status === 'uncollectible' || invoice.status === 'open'\n        )\n\n        if (unpaidInvoices.length > 0) {\n          this.accountService.addBlockedReason('Unpaid invoices')\n        } else if (this.accountService.hasBlockedReason('Unpaid invoices')) {\n          this.accountService.removeBlockedReason('Unpaid invoices')\n        }\n\n        this.factureState.next({\n          state: 'factures',\n          invoices: factures.data!.filter(\n            (invoice) =>\n              invoice.status === 'paid' ||\n              invoice.status === 'void' ||\n              invoice.status === 'draft'\n          ),\n          dues: unpaidInvoices,\n          upcoming,\n          hasMore: factures.has_more!,\n        })\n      } else if (upcoming && factures.data!.length === 0) {\n        this.factureState.next({ state: 'upcoming', upcoming })\n      } else {\n        this.factureState.next({ state: 'noInvoices' })\n      }\n    })\n  }\n\n  resetState() {\n    this.factureState.next({ state: 'loading' })\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAkCM,IAAO,kBAAP,MAAO,gBAAc;EAMzB,YACU,iBACA,aACA,gBACA,cAAiC;AAHjC,SAAA,kBAAA;AACA,SAAA,cAAA;AACA,SAAA,iBAAA;AACA,SAAA,eAAA;AATV,SAAA,eACE,IAAI,gBAA+B;MACjC,OAAO;KACR;AAQD,WAAO,MAAK;AACV,UACE,KAAK,YAAY,UAAS,EAAG,UAAU,cACvC,KAAK,aAAa,MAAM,SAAS,WACjC;AACA,aAAK,YAAW;MAClB,WAAW,KAAK,YAAY,UAAS,EAAG,UAAU,aAAa;AAC7D,aAAK,WAAU;MACjB;IACF,CAAC;EACH;EAEM,cAAW;;AACf,eAAS;QACP,UAAU,KAAK,gBACZ,iBAAiB;UAChB,SAAS,YAAY;SACtB,EACA,KACC,WAAW,CAAC,UAAS;AACnB,cAAI,MAAM,WAAW,KAAK;AACxB,mBAAO,GAAG,MAAS;UACrB;AACA,eAAK,aAAa,YAAY,KAAK;AACnC,gBAAM;QACR,CAAC,CAAC;QAEN,UAAU,KAAK,gBAAgB,YAAY;UACzC,SAAS,YAAY;UACrB,OAAO;SACR;OACF,EAAE,UAAU,CAAC,EAAE,UAAU,SAAQ,MAAM;AACtC,YAAI,SAAS,KAAM,SAAS,GAAG;AAC7B,gBAAM,iBAAiB,SAAS,KAAM,OACpC,CAAC,YACC,QAAQ,WAAW,mBAAmB,QAAQ,WAAW,MAAM;AAGnE,cAAI,eAAe,SAAS,GAAG;AAC7B,iBAAK,eAAe,iBAAiB,iBAAiB;UACxD,WAAW,KAAK,eAAe,iBAAiB,iBAAiB,GAAG;AAClE,iBAAK,eAAe,oBAAoB,iBAAiB;UAC3D;AAEA,eAAK,aAAa,KAAK;YACrB,OAAO;YACP,UAAU,SAAS,KAAM,OACvB,CAAC,YACC,QAAQ,WAAW,UACnB,QAAQ,WAAW,UACnB,QAAQ,WAAW,OAAO;YAE9B,MAAM;YACN;YACA,SAAS,SAAS;WACnB;QACH,WAAW,YAAY,SAAS,KAAM,WAAW,GAAG;AAClD,eAAK,aAAa,KAAK,EAAE,OAAO,YAAY,SAAQ,CAAE;QACxD,OAAO;AACL,eAAK,aAAa,KAAK,EAAE,OAAO,aAAY,CAAE;QAChD;MACF,CAAC;IACH;;EAEA,aAAU;AACR,SAAK,aAAa,KAAK,EAAE,OAAO,UAAS,CAAE;EAC7C;;;mCA9EW,iBAAc,mBAAA,eAAA,GAAA,mBAAA,WAAA,GAAA,mBAAA,cAAA,GAAA,mBAAA,mBAAA,CAAA;AAAA;mFAAd,iBAAc,SAAd,gBAAc,WAAA,YAFb,OAAM,CAAA;AAEd,IAAO,iBAAP;;sEAAO,gBAAc,CAAA;UAH1B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
