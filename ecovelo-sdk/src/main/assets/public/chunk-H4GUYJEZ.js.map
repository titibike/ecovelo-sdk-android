{
  "version": 3,
  "sources": ["src/app/services/api-wrappers/kyc.service.ts"],
  "sourcesContent": ["import { computed, Injectable, signal, effect, untracked } from '@angular/core'\nimport {\n  KYCService,\n  CyclistsService,\n  RetrieveProgram200ResponseConfigKycDocumentTypesInner,\n} from 'src/api-cyclist'\nimport { ToastService, ToastType } from '../utils/toast.service'\nimport { TranslateService } from '@ngx-translate/core'\nimport { firstValueFrom } from 'rxjs'\nimport { AccountService } from './account.service'\nimport { StorageService } from '../utils/storage.service'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\n\n// Enums to avoid booleans as requested\nexport enum DocumentValidationState {\n  PENDING = 'pending',\n  APPROVED = 'approved',\n  REJECTED = 'rejected',\n  MISSING = 'missing',\n  NOT_ENABLED = 'not_enabled',\n}\n\nexport enum DocumentRequirement {\n  MANDATORY = 'mandatory',\n  OPTIONAL = 'optional',\n  DISABLED = 'disabled',\n}\n\n// Interface for document upload that combines document type and files\nexport interface DocumentUploadRequest {\n  document_type: string\n  files: {\n    frontside?: string\n    backside?: string\n  }\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class KYCWrapperService {\n  kyc_document_types = signal<\n    RetrieveProgram200ResponseConfigKycDocumentTypesInner[]\n  >([])\n\n  //Retourne les types de documents activés par le programme (rajouter le .filter pour exclure les types de documents désactivés en prod)\n  enabledDocumentTypes = computed(() => {\n    return this.kyc_document_types().filter(\n      (doc) => doc.validation !== 'disabled'\n    )\n  })\n\n  //Retourne le status de la kyc en compararant le status des docs du cycliste avec ceux requis par le programme\n  kycCompletionState = computed(() => {\n    const requiredTypes = this.enabledDocumentTypes()\n    const cyclistState = this.accountService.cyclistState()\n    const cyclistDocs =\n      'cyclist' in cyclistState && cyclistState.cyclist.kyc_documents\n        ? Object.values(cyclistState.cyclist.kyc_documents)\n        : []\n\n    if (requiredTypes.length === 0) {\n      return DocumentValidationState.NOT_ENABLED\n    }\n\n    // Gather statuses for required docs\n    const statuses = requiredTypes.map((doc) => {\n      const cyclistDoc = cyclistDocs.find(\n        (cyclistDoc: any) => cyclistDoc.name === doc.name\n      )\n      if (!cyclistDoc) {\n        return DocumentValidationState.MISSING\n      }\n\n      const status = cyclistDoc.status\n      if (status === 'approved') {\n        return DocumentValidationState.APPROVED\n      }\n\n      return status\n    })\n\n    if (\n      statuses.every((status) => status === DocumentValidationState.APPROVED)\n    ) {\n      return DocumentValidationState.APPROVED\n    }\n\n    // Return REJECTED if any document is rejected (priority over pending)\n    if (\n      statuses.some((status) => status === DocumentValidationState.REJECTED)\n    ) {\n      return DocumentValidationState.REJECTED\n    }\n\n    // Return MISSING if any document is missing (priority over pending)\n    if (statuses.some((status) => status === DocumentValidationState.MISSING)) {\n      return DocumentValidationState.MISSING\n    }\n\n    // Return PENDING only if no documents are missing/rejected\n    if (statuses.some((status) => status === DocumentValidationState.PENDING)) {\n      return DocumentValidationState.PENDING\n    }\n\n    return DocumentValidationState.MISSING\n  })\n\n  //Ajoute une blocking reason si la kyc est incomplète\n  kycBlockingCheck = computed(() => {\n    const cyclistState = this.accountService.cyclistState()\n    if (!('cyclist' in cyclistState)) return\n\n    const enabledDocs = this.enabledDocumentTypes()\n\n    // Check if any enabled document is missing, rejected, or not created\n    const hasIncompleteKyc = enabledDocs.some((docType) => {\n      const cyclistDoc = Object.values(\n        cyclistState.cyclist.kyc_documents || {}\n      ).find((doc: any) => doc.name === docType.name)\n\n      // Document is missing if it doesn't exist or has missing/rejected status\n      return (\n        !cyclistDoc ||\n        cyclistDoc.status === DocumentValidationState.MISSING ||\n        cyclistDoc.status === DocumentValidationState.REJECTED\n      )\n    })\n\n    const blockedReason = 'KYC documents incomplete'\n    untracked(() => {\n      if (hasIncompleteKyc) {\n        this.accountService.addBlockedReason(blockedReason)\n      } else {\n        this.accountService.removeBlockedReason(blockedReason)\n      }\n    })\n  })\n\n  constructor(\n    private kycService: KYCService,\n    private cyclistsService: CyclistsService,\n    private toastService: ToastService,\n    private translate: TranslateService,\n    private accountService: AccountService,\n    private storage: StorageService,\n    private errorHandler: ErrorHandlerService\n  ) {\n    effect(() => {\n      this.kycBlockingCheck()\n    })\n  }\n\n  // Helper method to find existing document by name\n  private findExistingDocument(documentType: string): any | null {\n    const cyclistState = this.accountService.cyclistState()\n    if (!('cyclist' in cyclistState)) return null\n\n    return (\n      Object.values(cyclistState.cyclist.kyc_documents || {}).find(\n        (doc: any) => doc.name === documentType\n      ) || null\n    )\n  }\n\n  async uploadDocument(document: DocumentUploadRequest): Promise<void> {\n    if (!document.document_type) return\n\n    try {\n      // Check if document already exists for this cyclist\n      const existingDoc = this.findExistingDocument(document.document_type)\n      let documentId: string\n\n      if (existingDoc) {\n        // Document already exists, use its ID\n        documentId = existingDoc.id\n      } else {\n        // Document doesn't exist, create it first\n        const createResponse = await firstValueFrom(\n          this.kycService.createKycDocument({\n            createKycDocumentRequest: {\n              name: document.document_type,\n            },\n          })\n        )\n        documentId = createResponse.id!\n      }\n\n      // Upload files if we have a document ID and files\n      if (documentId && document.files) {\n        // Prepare files object for upload\n        const filesToUpload: any = {}\n\n        if (document.files.frontside) {\n          filesToUpload.frontside = document.files.frontside\n        }\n\n        if (document.files.backside) {\n          filesToUpload.backside = document.files.backside\n        }\n\n        // Upload all files in a single request\n        if (Object.keys(filesToUpload).length > 0) {\n          await firstValueFrom(\n            this.kycService.uploadFile({\n              id: documentId,\n              uploadFileRequest: {\n                files: filesToUpload,\n              },\n            })\n          )\n        }\n      }\n\n      // Note: Cyclist data will be refreshed once at the end after all uploads\n    } catch (error) {\n      this.errorHandler.handleError(error)\n      throw error\n    }\n  }\n\n  async setKycDocumentTypes() {\n    const program = await this.storage.get('program')\n    if (program?.config?.kyc_document_types) {\n      this.kyc_document_types.set(program.config.kyc_document_types)\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["DocumentValidationState", "DocumentRequirement", "cyclistDoc"]
}
