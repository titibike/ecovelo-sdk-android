{"version":3,"sources":["node_modules/@capacitor/push-notifications/dist/esm/index.js","src/app/components/modals/push-notifications/push-notifications.component.ts","src/app/services/external/fcm.service.ts"],"sourcesContent":["import { registerPlugin } from '@capacitor/core';\nconst PushNotifications = registerPlugin('PushNotifications', {});\nexport * from './definitions';\nexport { PushNotifications };\n","import { Component } from '@angular/core'\nimport {\n  IonContent,\n  IonButton,\n  ModalController,\n} from '@ionic/angular/standalone'\nimport { TranslateModule } from '@ngx-translate/core'\nimport { CommonModule } from '@angular/common'\nimport { FcmService } from '../../../services/external/fcm.service'\nimport { AppstateService } from 'src/app/services/internal/appstate.service'\nimport { ErrorHandlerService } from 'src/app/services/utils/error-handler.service'\n\n@Component({\n  selector: 'app-push-notifications',\n  template: `\n    <ion-content>\n      <div class=\"ecl-congrats-modal ecl-congrats-modal--push-notifications\">\n        <div class=\"ecl-congrats-modal__icon ecl-congrats-modal__icon--bg\">\n          <img src=\"assets/icon/animated/notification.gif\" />\n        </div>\n        <h1>{{ 'push_notifications.title' | translate }}</h1>\n        <p class=\"ecl-congrats-modal--push-notifications__description\">\n          {{ 'push_notifications.description' | translate }}\n        </p>\n\n        <div class=\"ecl-congrats-modal__buttons\">\n          <ion-button expand=\"block\" color=\"light\" (click)=\"accept()\">\n            {{ 'push_notifications.accept' | translate }}\n          </ion-button>\n          <ion-button\n            expand=\"block\"\n            fill=\"clear\"\n            color=\"light\"\n            (click)=\"dismiss()\"\n          >\n            {{ 'push_notifications.skip' | translate }}\n          </ion-button>\n        </div>\n      </div>\n    </ion-content>\n  `,\n  imports: [CommonModule, TranslateModule, IonContent, IonButton],\n})\nexport class PushNotificationsComponent {\n  constructor(\n    private modalCtrl: ModalController,\n    private fcmService: FcmService,\n    private appState: AppstateService,\n    private errorHandler: ErrorHandlerService\n  ) {}\n\n  async accept() {\n    try {\n      await this.fcmService.askForPermission().then(() => {\n        const currentState = this.appState.getAppState()\n        if (\n          currentState.state === 'fresh_cyclist' ||\n          currentState.state === 'new_cyclist'\n        ) {\n          this.appState.setAppState({\n            ...currentState,\n            push_notifications: 'shown',\n          })\n        }\n        this.modalCtrl.dismiss()\n      })\n    } catch (error) {\n      this.errorHandler.handleError(error)\n    }\n  }\n\n  async dismiss() {\n    const currentState = this.appState.getAppState()\n    if (\n      currentState.state === 'fresh_cyclist' ||\n      currentState.state === 'new_cyclist'\n    ) {\n      await this.appState.setAppState({\n        ...currentState,\n        push_notifications: 'shown',\n      })\n    }\n    await this.modalCtrl.dismiss()\n  }\n}\n","import { Injectable } from '@angular/core'\nimport { Capacitor } from '@capacitor/core'\nimport { PushNotifications } from '@capacitor/push-notifications'\nimport { ModalController } from '@ionic/angular/standalone'\nimport { PushNotificationsComponent } from '../../components/modals/push-notifications/push-notifications.component'\nimport { DevicesService } from 'src/api-cyclist'\nimport { environment } from 'src/environments/environment'\nimport { StorageService } from '../utils/storage.service'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\nimport { AppState, AppstateService } from '../internal/appstate.service'\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class FcmService {\n  appState: AppState\n  constructor(\n    private modalCtrl: ModalController,\n    private devicesService: DevicesService,\n    private storage: StorageService,\n    private errorHandler: ErrorHandlerService,\n    private appStateService: AppstateService\n  ) {\n    this.appStateService.appState.subscribe((state) => {\n      this.appState = state\n    })\n  }\n\n  async checkPermission() {\n    let permission: any\n    if (Capacitor.isNativePlatform()) {\n      permission = await PushNotifications.checkPermissions()\n    } else {\n      permission = null\n    }\n    if (\n      Capacitor.isNativePlatform() &&\n      (this.appState.state === 'new_cyclist' ||\n        this.appState.state === 'fresh_cyclist') &&\n      permission?.receive === 'prompt' &&\n      this.appState.push_notifications === 'not_shown'\n    ) {\n      await this.initPush()\n    }\n  }\n\n  async initPush() {\n    if (Capacitor.isNativePlatform()) {\n      const modal = await this.modalCtrl.create({\n        component: PushNotificationsComponent,\n        cssClass: 'fullscreen-modal',\n      })\n      await modal.present()\n      await modal.onDidDismiss()\n    }\n  }\n\n  public async askForPermission() {\n    await PushNotifications.requestPermissions()\n      .then(async (permission) => {\n        if (permission.receive === 'granted') {\n          await this.registerPush()\n        } else {\n          console.error('No permission for push granted')\n        }\n      })\n      .catch((error) => {\n        this.errorHandler.handleError(error)\n      })\n  }\n\n  public async registerPush() {\n    PushNotifications.addListener('registration', async (token: any) => {\n      await this.storage.set('fcmToken', token.value)\n      this.devicesService\n        .subscribeDevice({\n          program: environment.program,\n          subscribeDeviceRequest: {\n            token: token.value,\n          },\n        })\n        .subscribe({\n          error: async (error) => {\n            console.error('Error subscribing to device', error)\n          },\n          next: async () => {},\n        })\n    })\n    PushNotifications.addListener(\n      'pushNotificationActionPerformed',\n      (notification) => {\n        //Do something with the notif.\n      }\n    )\n    try {\n      await PushNotifications.register()\n    } catch (error) {\n      this.errorHandler.handleError(error)\n    }\n  }\n\n  public async unRegisterPush() {\n    try {\n      await PushNotifications.unregister()\n      await PushNotifications.removeAllListeners()\n      const token = await this.storage.get('fcmToken')\n      if (token) {\n        this.devicesService\n          .unsubscribeDevice({\n            program: environment.program,\n            token: token,\n          })\n          .subscribe()\n        await this.storage.remove('fcmToken')\n      }\n    } catch (error) {\n      this.errorHandler.handleError(error)\n    }\n  }\n}\n"],"mappings":"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","names":[],"x_google_ignoreList":[0]}