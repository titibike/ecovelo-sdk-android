<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Breizhgo - Ecovelo SDK Test</title>
    <!-- Capacitor Bridge - doit √™tre charg√© en premier -->
    <script src="capacitor.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0055A4 0%, #003D7A 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
            color: white;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 0 auto;
            color: #333;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0055A4 0%, #003D7A 100%);
            border-radius: 16px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: 0 4px 15px rgba(0,85,164,0.4);
        }
        
        h1 {
            color: #0055A4;
            margin-bottom: 4px;
            font-size: 24px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .section {
            background: #F5F5F5;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: left;
        }
        
        .section h3 {
            color: #0055A4;
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section p {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }
        
        #config {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #333;
            background: white;
            padding: 10px;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
        }
        
        .badge {
            display: inline-block;
            background: #E4002B;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin: 4px;
        }
        
        .badge.success {
            background: #4CAF50;
        }
        
        .badge.warning {
            background: #FF9800;
        }
        
        .btn {
            display: block;
            width: 100%;
            background: #0055A4;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #003D7A;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: #666;
        }
        
        .btn.camera {
            background: #4CAF50;
        }
        
        #photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            margin-top: 10px;
            display: none;
        }
        
        #status {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background: #E3F2FD;
            border-radius: 8px;
        }
        
        .footer {
            margin-top: 16px;
            font-size: 11px;
            color: #999;
        }
        
        .test-result {
            font-size: 11px;
            padding: 8px;
            margin: 8px 0;
            border-radius: 8px;
            text-align: left;
        }
        
        .test-result.success {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .test-result.error {
            background: #FFEBEE;
            color: #C62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üö≤</div>
        <h1>Breizhgo SDK</h1>
        <p class="subtitle">Test d'int√©gration Capacitor</p>
        
        <div id="badges">
            <span id="mode-badge" class="badge">MODE SDK</span>
            <span id="capacitor-badge" class="badge warning">CAPACITOR ?</span>
        </div>
        
        <div id="status">Initialisation...</div>
        
        <!-- Section Camera -->
        <div class="section">
            <h3>üì∑ Test Camera (Capacitor)</h3>
            <p>Teste le plugin Camera Capacitor natif.</p>
            <button id="camera-btn" class="btn camera">
                Prendre une photo
            </button>
            <img id="photo-preview" alt="Photo preview">
            <div id="camera-result"></div>
        </div>
        
        <!-- Section Auth -->
        <div class="section">
            <h3>üîê Test Auth (EcoveloNative)</h3>
            <button id="auth-btn" class="btn">
                Tester l'authentification
            </button>
            <button id="login-btn" class="btn secondary" style="display:none;">
                Se connecter
            </button>
            <div id="auth-result"></div>
        </div>
        
        <!-- Section Config -->
        <div class="section">
            <h3>‚öôÔ∏è Configuration SDK</h3>
            <div id="config">Chargement...</div>
        </div>
        
        <button id="close-btn" class="btn secondary">
            Fermer le SDK
        </button>
        
        <p class="footer">Ecovelo SDK Android v1.0.0 + Capacitor 6.1</p>
    </div>
    
    <script>
        // Variables globales
        var isCapacitorReady = false;
        var Camera = null;
        var EcoveloNative = null;
        
        // Attendre que Capacitor soit pr√™t
        function waitForCapacitor() {
            return new Promise(function(resolve) {
                var attempts = 0;
                var check = setInterval(function() {
                    attempts++;
                    if (window.Capacitor && window.Capacitor.Plugins) {
                        clearInterval(check);
                        resolve(true);
                    } else if (attempts > 30) {
                        clearInterval(check);
                        resolve(false);
                    }
                }, 100);
            });
        }
        
        // Initialisation
        async function init() {
            var statusEl = document.getElementById('status');
            var configEl = document.getElementById('config');
            var capacitorBadge = document.getElementById('capacitor-badge');
            var modeBadge = document.getElementById('mode-badge');
            
            statusEl.textContent = '‚è≥ Attente du bridge Capacitor...';
            
            var capacitorReady = await waitForCapacitor();
            
            if (capacitorReady && window.Capacitor && window.Capacitor.Plugins) {
                isCapacitorReady = true;
                Camera = window.Capacitor.Plugins.Camera;
                EcoveloNative = window.Capacitor.Plugins.EcoveloNative;
                
                capacitorBadge.textContent = 'CAPACITOR ‚úì';
                capacitorBadge.className = 'badge success';
                statusEl.textContent = '‚úÖ Capacitor pr√™t!';
                
                // Tester EcoveloNative
                if (EcoveloNative) {
                    try {
                        var config = await EcoveloNative.getConfig();
                        configEl.textContent = JSON.stringify(config, null, 2);
                        modeBadge.textContent = 'SDK MODE';
                        modeBadge.className = 'badge success';
                        
                        // V√©rifier l'auth
                        var auth = await EcoveloNative.isAuthenticated();
                        if (auth.authenticated) {
                            document.getElementById('login-btn').style.display = 'none';
                        } else {
                            document.getElementById('login-btn').style.display = 'block';
                        }
                    } catch (e) {
                        configEl.textContent = 'Erreur: ' + e.message;
                    }
                } else {
                    configEl.textContent = 'EcoveloNative plugin non disponible\nPlugins: ' + Object.keys(window.Capacitor.Plugins).join(', ');
                }
            } else {
                capacitorBadge.textContent = 'NO CAPACITOR';
                capacitorBadge.className = 'badge';
                statusEl.textContent = '‚ö†Ô∏è Bridge Capacitor non d√©tect√© (mode web)';
                configEl.textContent = 'Mode standalone - pas de bridge natif';
            }
        }
        
        // Prendre une photo
        async function takePhoto() {
            var resultEl = document.getElementById('camera-result');
            var previewEl = document.getElementById('photo-preview');
            
            resultEl.innerHTML = '<div class="test-result">‚è≥ Ouverture cam√©ra...</div>';
            
            try {
                if (!isCapacitorReady || !Camera) {
                    throw new Error('Plugin Camera non disponible');
                }
                
                console.log('Calling Camera.getPhoto...');
                
                // Appeler directement getPhoto - le plugin g√®re les permissions
                var photo = await Camera.getPhoto({
                    quality: 80,
                    resultType: 'dataUrl',
                    saveToGallery: false
                });
                
                console.log('Photo result:', photo);
                
                if (photo.dataUrl) {
                    previewEl.src = photo.dataUrl;
                    previewEl.style.display = 'block';
                    resultEl.innerHTML = '<div class="test-result success">‚úÖ Photo prise avec succ√®s!</div>';
                } else if (photo.base64String) {
                    previewEl.src = 'data:image/jpeg;base64,' + photo.base64String;
                    previewEl.style.display = 'block';
                    resultEl.innerHTML = '<div class="test-result success">‚úÖ Photo prise (base64)!</div>';
                } else {
                    resultEl.innerHTML = '<div class="test-result success">‚úÖ Photo: ' + JSON.stringify(photo) + '</div>';
                }
                
            } catch (e) {
                console.error('Camera error:', e);
                previewEl.style.display = 'none';
                resultEl.innerHTML = '<div class="test-result error">‚ùå ' + e.message + '</div>';
            }
        }
        
        // Tester l'authentification
        async function testAuth() {
            var resultEl = document.getElementById('auth-result');
            var loginBtn = document.getElementById('login-btn');
            
            resultEl.innerHTML = '<div class="test-result">‚è≥ Test auth...</div>';
            
            try {
                if (!isCapacitorReady || !EcoveloNative) {
                    throw new Error('Plugin EcoveloNative non disponible');
                }
                
                var auth = await EcoveloNative.isAuthenticated();
                var token = await EcoveloNative.getAccessToken();
                var userInfo = await EcoveloNative.getUserInfo();
                
                var html = '<div class="test-result success">';
                html += '‚úÖ Auth: ' + (auth.authenticated ? 'Connect√©' : 'Non connect√©') + '<br>';
                html += 'Token: ' + (token.hasToken ? '‚úì Pr√©sent' : '‚úó Absent') + '<br>';
                if (userInfo.authenticated) {
                    html += 'User: ' + (userInfo.email || userInfo.firstName || 'N/A');
                }
                html += '</div>';
                resultEl.innerHTML = html;
                
                loginBtn.style.display = auth.authenticated ? 'none' : 'block';
                
            } catch (e) {
                console.error('Auth error:', e);
                resultEl.innerHTML = '<div class="test-result error">‚ùå ' + e.message + '</div>';
            }
        }
        
        // Demander la connexion
        async function requestLogin() {
            var resultEl = document.getElementById('auth-result');
            resultEl.innerHTML = '<div class="test-result">‚è≥ Demande de connexion...</div>';
            
            try {
                if (!EcoveloNative) {
                    throw new Error('Plugin non disponible');
                }
                await EcoveloNative.requestLogin();
                resultEl.innerHTML = '<div class="test-result success">‚úÖ Demande envoy√©e √† l\'app h√¥te</div>';
            } catch (e) {
                resultEl.innerHTML = '<div class="test-result error">‚ùå ' + e.message + '</div>';
            }
        }
        
        // Fermer le SDK
        async function closeSDK() {
            try {
                if (EcoveloNative) {
                    await EcoveloNative.close({ result: 'user_closed' });
                } else {
                    alert('Fermeture non disponible en mode web');
                }
            } catch (e) {
                console.log('Close error:', e);
                alert('Erreur: ' + e.message);
            }
        }
        
        // Attacher les √©v√©nements aux boutons
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('camera-btn').addEventListener('click', takePhoto);
            document.getElementById('auth-btn').addEventListener('click', testAuth);
            document.getElementById('login-btn').addEventListener('click', requestLogin);
            document.getElementById('close-btn').addEventListener('click', closeSDK);
            
            // Initialiser
            init();
        });
        
        // √âcouter les √©v√©nements SDK
        window.addEventListener('ecovelo-sdk-ready', function(event) {
            console.log('[Placeholder] SDK Ready:', event.detail);
            document.getElementById('config').textContent = JSON.stringify(event.detail, null, 2);
        });
        
        window.addEventListener('ecovelo-token-updated', function(event) {
            console.log('[Placeholder] Token updated:', event.detail);
            document.getElementById('status').textContent = 'üîÑ Token mis √† jour!';
            testAuth();
        });
    </script>
</body>
</html>
