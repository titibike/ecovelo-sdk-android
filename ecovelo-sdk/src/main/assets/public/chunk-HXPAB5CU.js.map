{
  "version": 3,
  "sources": ["src/app/services/api-wrappers/abonnement.service.ts"],
  "sourcesContent": ["import { Injectable, signal, WritableSignal, effect } from '@angular/core'\nimport {\n  AbonnementsService,\n  ListAbonnement200ResponseAllOfDataInner,\n  ListForfait200ResponseAllOfDataInner,\n} from 'src/api-cyclist'\n\n// Type personnalisé pour forcer forfait en tant qu'any\ntype AbonnementWithAnyForfait = Omit<\n  ListAbonnement200ResponseAllOfDataInner,\n  'forfait'\n> & {\n  forfait?: any\n}\nimport { environment } from 'src/environments/environment'\nimport { AlertController, LoadingController } from '@ionic/angular'\nimport { Router } from '@angular/router'\nimport { TranslateService } from '@ngx-translate/core'\nimport { ForfaitsWrapperService } from './forfaits.service'\nimport { ToastService, ToastType } from '../utils/toast.service'\nimport { SubscriptionProcessService } from '../utils/subscription-process.service'\nimport { AuthService, AuthState } from '../external/auth.service'\nimport { AccountService } from './account.service'\nimport { LanguageService } from '../utils/language.service'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\n\nexport type AbonnementsState =\n  | { state: 'loading' }\n  | {\n      state: 'no_data'\n    }\n  | {\n      state: 'success'\n      abonnements: ListAbonnement200ResponseAllOfDataInner[]\n    }\n  | {\n      state: 'error'\n      error: Error\n    }\n\n//Je ne spécifie pas tout les status d'abonnements, seulement ceux qui m'intéressent pour le \"current\"\nexport type CurrentAbonnementState =\n  | { state: 'unknown' }\n  | { state: 'default'; forfait: ListForfait200ResponseAllOfDataInner }\n  | {\n      state: 'active'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'waiting_validation'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'incomplete'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'deletion_requested'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'unpaid'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'past_due'\n      abonnement: AbonnementWithAnyForfait\n    }\n  | {\n      state: 'deletion_requested'\n      abonnement: AbonnementWithAnyForfait\n    }\n\nexport type AbonnementItemState = {\n  state:\n    | 'no_abo'\n    | 'active'\n    | 'expire_soon'\n    | 'recurring'\n    | 'waiting_validation'\n    | 'past_due'\n    | 'deletion_requested'\n    | 'unpaid'\n  message: string\n  color?: string\n}\n\nexport interface CreateAbonnementParams {\n  forfaitID: string\n  supporting_documents?: any\n  reduction?: string\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class AbonnementWrapperService {\n  public listAbonnementsState: WritableSignal<AbonnementsState> = signal({\n    state: 'loading',\n  })\n  public currentAbonnementState = signal<CurrentAbonnementState>({\n    state: 'unknown',\n  })\n  authState: AuthState = { state: 'SignedOut' }\n  defaultForfait: ListForfait200ResponseAllOfDataInner | undefined\n\n  constructor(\n    private abonnementsService: AbonnementsService,\n    private alertController: AlertController,\n    private loadingCtrl: LoadingController,\n    private translate: TranslateService,\n    private forfaitsService: ForfaitsWrapperService,\n    private toastService: ToastService,\n    private SubscriptionProcessService: SubscriptionProcessService,\n    private router: Router,\n    private authService: AuthService,\n    private accountService: AccountService,\n    private errorHandler: ErrorHandlerService\n  ) {\n    this.forfaitsService.getDefaultForfait().then((forfait) => {\n      this.defaultForfait = forfait\n    })\n    effect(() => {\n      this.authState = this.authService.authState()\n      if (\n        this.authState.state === 'SignedIn' &&\n        this.listAbonnementsState().state === 'loading'\n      ) {\n        this.getAbonnements()\n      } else if (this.authState.state === 'SignedOut') {\n        this.resetState()\n      }\n    })\n  }\n  async getAbonnements() {\n    return new Promise((resolve, reject) => {\n      this.abonnementsService\n        .listAbonnement({\n          program: environment.program,\n          limit: 100,\n          expand: ['forfait.plan'],\n        })\n        .subscribe({\n          next: (res) => {\n            this.checkAbonnements(res.data)\n            resolve(res)\n          },\n          error: (error) => {\n            this.errorHandler.handleError(error)\n            this.listAbonnementsState.set({ state: 'error', error })\n            reject(error)\n          },\n        })\n    })\n  }\n  async createAbonnement(params: CreateAbonnementParams) {\n    return new Promise((resolve, reject) => {\n      this.abonnementsService\n        .createAbonnement({\n          program: environment.program,\n          createAbonnementRequest: {\n            forfait: params.forfaitID,\n            supporting_documents: params.supporting_documents,\n            reduction: params.reduction,\n          },\n        })\n        .subscribe({\n          next: async (abonnement) => {\n            await this.getAbonnements()\n            await this.SubscriptionProcessService.clearProcess()\n            await this.router.navigate(['/abo-congrats'])\n            resolve(abonnement)\n          },\n          error: (error) => {\n            this.errorHandler.handleError(error)\n            reject(error)\n          },\n        })\n    })\n  }\n\n  async checkAbonnements(\n    abonnements: ListAbonnement200ResponseAllOfDataInner[] | undefined\n  ) {\n    /********* Si pas d'abonnements ********/\n    const defaultForfait = await this.forfaitsService.getDefaultForfait()\n    if (!abonnements || abonnements.length === 0) {\n      this.listAbonnementsState.set({ state: 'no_data' })\n      defaultForfait\n        ? this.currentAbonnementState.set({\n            state: 'default',\n            forfait: defaultForfait,\n          })\n        : this.currentAbonnementState.set({ state: 'unknown' })\n      return\n    }\n    /********* Gestion de la liste des abonnements ********/\n\n    this.listAbonnementsState.set({ state: 'success', abonnements })\n    /********* Gestion de l'abonnement en cours ********/\n    const currentAbonnement = abonnements.find(\n      (ab) =>\n        ab.status === 'active' ||\n        ab.status === 'waiting_validation' ||\n        ab.status === 'past_due' ||\n        ab.status === 'incomplete' ||\n        ab.status === 'unpaid' ||\n        ab.status === 'deletion_requested'\n    )\n    if (!currentAbonnement) {\n      this.currentAbonnementState.set({\n        state: 'default',\n        forfait: defaultForfait!,\n      })\n      return\n    }\n\n    if (currentAbonnement.can_rent === false) {\n      this.accountService.addBlockedReason(\n        'Subscription does not allow renting'\n      )\n    } else {\n      if (\n        this.accountService.hasBlockedReason(\n          'Subscription does not allow renting'\n        )\n      ) {\n        this.accountService.removeBlockedReason(\n          'Subscription does not allow renting'\n        )\n      }\n    }\n    switch (currentAbonnement?.status) {\n      case 'active':\n        this.currentAbonnementState.set({\n          state: 'active',\n          abonnement: currentAbonnement,\n        })\n\n        break\n      case 'waiting_validation':\n        this.currentAbonnementState.set({\n          state: 'waiting_validation',\n          abonnement: currentAbonnement,\n        })\n        break\n      case 'incomplete':\n        this.currentAbonnementState.set({\n          state: 'incomplete',\n          abonnement: currentAbonnement,\n        })\n        break\n      case 'unpaid':\n        this.currentAbonnementState.set({\n          state: 'unpaid',\n          abonnement: currentAbonnement,\n        })\n        break\n      case 'past_due':\n        this.currentAbonnementState.set({\n          state: 'past_due',\n          abonnement: currentAbonnement,\n        })\n        break\n      case 'deletion_requested':\n        this.currentAbonnementState.set({\n          state: 'deletion_requested',\n          abonnement: currentAbonnement,\n        })\n        break\n    }\n  }\n  async requestDeletion() {\n    const alert = await this.alertController.create({\n      header: this.translate.instant('subscription.deletion.confirm.title'),\n      message: this.translate.instant('subscription.deletion.confirm.message'),\n      buttons: [\n        {\n          text: this.translate.instant('subscription.deletion.confirm.cancel'),\n          role: 'cancel',\n        },\n        {\n          text: this.translate.instant('subscription.deletion.confirm.confirm'),\n          handler: async () => {\n            await this.deleteAbonnement()\n          },\n        },\n      ],\n    })\n    await alert.present()\n  }\n  async deleteAbonnement() {\n    const loading = await this.loadingCtrl.create({\n      message: this.translate.instant('subscription.deletion.loading'),\n    })\n    await loading.present()\n    const currentAbonnement = this.currentAbonnementState()\n    if (\n      currentAbonnement.state === 'unknown' ||\n      currentAbonnement.state === 'default'\n    ) {\n      await this.toastService.createWithJustMessage(\n        this.translate.instant('subscription.deletion.no_active'),\n        ToastType.Error\n      )\n      return\n    } else if (currentAbonnement.state === 'deletion_requested') {\n      await this.toastService.createWithJustMessage(\n        this.translate.instant('subscription.deletion.already_requested'),\n        ToastType.Error\n      )\n      return\n    } else {\n      this.abonnementsService\n        .deleteAbonnement({\n          program: environment.program,\n          id: currentAbonnement.abonnement.id!,\n        })\n        .subscribe({\n          next: async () => {\n            this.toastService.createWithJustMessage(\n              this.translate.instant('subscription.deletion.success'),\n              ToastType.Success\n            )\n            this.accountService.removeBlockedReason(\n              'Subscription does not allow renting'\n            )\n            this.getAbonnements()\n            await loading.dismiss()\n          },\n          error: async (error) => {\n            this.errorHandler.handleError(error)\n            await loading.dismiss()\n          },\n        })\n    }\n  }\n\n  getDaysUntilExpiration(\n    abonnement: ListAbonnement200ResponseAllOfDataInner\n  ): number | null {\n    if (!abonnement.cancel_at) return null\n    const now = Date.now()\n    const expirationDate = abonnement.cancel_at * 1000\n    return Math.floor((expirationDate - now) / (1000 * 60 * 60 * 24))\n  }\n\n  shouldShowExpirationWarning(\n    abonnement: ListAbonnement200ResponseAllOfDataInner\n  ): boolean {\n    if (!abonnement.forfait?.plan?.interval) return false\n    const daysUntilExpiration = this.getDaysUntilExpiration(abonnement)\n    if (daysUntilExpiration === null) return false\n\n    switch (abonnement.forfait.plan.interval) {\n      case 'week':\n        return daysUntilExpiration <= 2\n      case 'month':\n        return daysUntilExpiration <= 5\n      case 'year':\n        return daysUntilExpiration <= 14\n      default:\n        return false\n    }\n  }\n\n  resetState() {\n    this.listAbonnementsState.set({ state: 'loading' })\n    this.currentAbonnementState.set({ state: 'unknown' })\n  }\n}\n"],
  "mappings": "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",
  "names": ["SubscriptionProcessService"]
}
