{
  "version": 3,
  "sources": ["src/app/services/api-wrappers/payment-method.service.ts"],
  "sourcesContent": ["import { computed, effect, Injectable, signal } from '@angular/core'\nimport {\n  CardsService,\n  ListCards200ResponseAllOfDataInner,\n} from 'src/api-cyclist'\nimport { environment } from 'src/environments/environment'\nimport { LoadingController } from '@ionic/angular'\nimport { TranslateService } from '@ngx-translate/core'\nimport { firstValueFrom } from 'rxjs'\nimport { AccountService, cyclistState } from './account.service'\nimport { AuthService } from '../external/auth.service'\nimport { ErrorHandlerService } from '../utils/error-handler.service'\n\nexport type paymentMethodsState =\n  | { state: 'loading' }\n  | {\n      state: 'success'\n      paymentMethods: ListCards200ResponseAllOfDataInner[]\n    }\n  | { state: 'error'; error: any }\n  | { state: 'no_data' }\n\ntype CardState = 'valid' | 'expire_soon' | 'expired' | 'unknown' | 'no_default'\n\ninterface CardDetails {\n  state: CardState\n  formattedNumber: string\n  expiryDate: string\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class PaymentMethodsService {\n  paymentMethodsState = signal<paymentMethodsState>({\n    state: 'loading',\n  })\n  cyclistState: cyclistState\n  defaultPaymentMethod = computed(() => {\n    const state = this.paymentMethodsState()\n    if (state.state !== 'success') {\n      return undefined\n    }\n    const cyclistState = this.accountService.cyclistState()\n    if (cyclistState.state === 'unknown' || cyclistState.state === 'error') {\n      return undefined\n    }\n    return state.paymentMethods.find(\n      (pm) =>\n        pm.id ===\n        cyclistState.cyclist.registrations?.data?.[0]?.customer\n          ?.invoice_settings?.default_payment_method\n    )\n  })\n\n  // Add computed signal for card state\n  cardState = computed(() => {\n    const card = this.defaultPaymentMethod()\n    if (!card) {\n      return {\n        state: 'no_default' as CardState,\n        formattedNumber: '',\n        expiryDate: '',\n      }\n    }\n    const today = new Date()\n    const cardExpDate = new Date(\n      card.card?.exp_year || 0,\n      card.card?.exp_month || 1,\n      0,\n      23,\n      59,\n      59\n    )\n\n    const formattedMonth = (card.card?.exp_month || 0)\n      .toString()\n      .padStart(2, '0')\n    const formattedExpiry = `${formattedMonth}/${card.card?.exp_year\n      ?.toString()\n      .slice(-2)}`\n    const formattedNumber = `CB **** ${card.card?.last4}`\n\n    if (cardExpDate < today) {\n      return {\n        state: 'expired' as CardState,\n        formattedNumber,\n        expiryDate: formattedExpiry,\n      }\n    }\n\n    const oneMonthFromNow = new Date()\n    oneMonthFromNow.setMonth(today.getMonth() + 1)\n    if (cardExpDate <= oneMonthFromNow) {\n      return {\n        state: 'expire_soon' as CardState,\n        formattedNumber,\n        expiryDate: formattedExpiry,\n      }\n    }\n\n    return {\n      state: 'valid' as CardState,\n      formattedNumber,\n      expiryDate: formattedExpiry,\n    }\n  })\n\n  constructor(\n    private cardsService: CardsService,\n    private loadingCtrl: LoadingController,\n    private translateService: TranslateService,\n    private accountService: AccountService,\n    private authService: AuthService,\n    private errorHandler: ErrorHandlerService\n  ) {\n    effect(() => {\n      this.cyclistState = this.accountService.cyclistState()\n      if (\n        this.cyclistState.state !== 'unknown' &&\n        this.paymentMethodsState().state === 'loading'\n      ) {\n        this.getPaymentMethods()\n      } else if (this.cyclistState.state === 'unknown') {\n        this.resetState()\n      }\n    })\n    effect(() => {\n      if (this.authService.authState().state === 'SignedOut') {\n        this.resetState()\n      }\n    })\n  }\n\n  async getPaymentMethods() {\n    if (\n      this.cyclistState.state !== 'unknown' &&\n      this.cyclistState.state !== 'error'\n    ) {\n      const res = await firstValueFrom(\n        this.cardsService.listCards({\n          cyclist: this.cyclistState.cyclist.id!,\n          program: environment.program,\n        })\n      )\n      if (res.data && res.data.length > 0) {\n        this.paymentMethodsState.set({\n          state: 'success',\n          paymentMethods: res.data,\n        })\n\n        // Check if there's at least one valid payment method\n        const hasValidPaymentMethod = res.data.some((card) => {\n          const cardState = this.getCardState(card)\n          return cardState.state === 'valid'\n        })\n\n        // Update can_rent status based on payment method validity\n        if (!hasValidPaymentMethod) {\n          this.accountService.addBlockedReason(\n            'No valid payment method available'\n          )\n        } else {\n          this.accountService.removeBlockedReason(\n            'No valid payment method available'\n          )\n        }\n      } else {\n        this.paymentMethodsState.set({ state: 'no_data' })\n        this.accountService.addBlockedReason(\n          'No valid payment method available'\n        )\n      }\n    }\n  }\n  async setDefaultCard(cardId: string) {\n    try {\n      await firstValueFrom(\n        this.cardsService.updateCard({\n          program: environment.program,\n          cyclist: this.accountService.getCurrentCyclist().id!,\n          id: cardId,\n          body: { default: true },\n        })\n      )\n      const currentCyclist = this.accountService.getCurrentCyclist()\n      this.accountService.updateCyclistData({\n        ...currentCyclist,\n        registrations: {\n          ...currentCyclist.registrations,\n          data: [\n            {\n              ...currentCyclist.registrations?.data?.[0],\n              customer: {\n                ...currentCyclist.registrations?.data?.[0]?.customer,\n                invoice_settings: {\n                  ...currentCyclist.registrations?.data?.[0]?.customer\n                    ?.invoice_settings,\n                  default_payment_method: cardId,\n                },\n              },\n            },\n          ],\n        },\n      })\n      await this.getPaymentMethods()\n    } catch (error) {\n      this.errorHandler.handleError(error)\n      throw error\n    }\n  }\n  async deleteCard(cardId: string) {\n    if (\n      this.cyclistState.state !== 'unknown' &&\n      this.cyclistState.state !== 'error'\n    ) {\n      const loading = await this.loadingCtrl.create({\n        message: this.translateService.instant('loading.deleting_card'),\n      })\n      await loading.present()\n      try {\n        await firstValueFrom(\n          this.cardsService.deleteCard({\n            program: environment.program,\n            cyclist: this.cyclistState.cyclist.id!,\n            id: cardId,\n          })\n        )\n        await this.getPaymentMethods()\n      } catch (error) {\n        this.errorHandler.handleError(error)\n        throw error\n      } finally {\n        await loading.dismiss()\n      }\n    }\n  }\n\n  // Make getCardState private since we now use the computed signal\n  private getCardState(card: ListCards200ResponseAllOfDataInner): CardDetails {\n    if (!card) {\n      return {\n        state: 'unknown',\n        formattedNumber: '',\n        expiryDate: '',\n      }\n    }\n    const today = new Date()\n    const cardExpDate = new Date(\n      card.card?.exp_year || 0,\n      card.card?.exp_month || 1,\n      0,\n      23,\n      59,\n      59\n    )\n\n    const formattedMonth = (card.card?.exp_month || 0)\n      .toString()\n      .padStart(2, '0')\n    const formattedExpiry = `${formattedMonth}/${card.card?.exp_year\n      ?.toString()\n      .slice(-2)}`\n    const formattedNumber = `CB **** ${card.card?.last4}`\n\n    if (cardExpDate < today) {\n      return {\n        state: 'expired',\n        formattedNumber,\n        expiryDate: formattedExpiry,\n      }\n    }\n\n    const oneMonthFromNow = new Date()\n    oneMonthFromNow.setMonth(today.getMonth() + 1)\n    if (cardExpDate <= oneMonthFromNow) {\n      return {\n        state: 'expire_soon',\n        formattedNumber,\n        expiryDate: formattedExpiry,\n      }\n    }\n\n    return {\n      state: 'valid',\n      formattedNumber,\n      expiryDate: formattedExpiry,\n    }\n  }\n\n  resetState() {\n    this.paymentMethodsState.set({ state: 'loading' })\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
