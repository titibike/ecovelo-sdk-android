# GitHub Actions workflow pour créer des releases automatiques
# Se déclenche lors du push d'un tag de version (ex: v1.0.0, v1.2.3-beta)
#
# Ce workflow :
# 1. Build le SDK pour vérifier qu'il compile
# 2. Crée une release GitHub avec le AAR attaché
# 3. JitPack détectera automatiquement le tag et publiera le package

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build SDK (Release)
        run: ./gradlew :ecovelo-sdk:assembleRelease -Pversion=${{ steps.version.outputs.VERSION }}

      - name: Run tests
        run: ./gradlew :ecovelo-sdk:testReleaseUnitTest
        continue-on-error: true

      - name: Rename AAR with version
        run: |
          mv ecovelo-sdk/build/outputs/aar/ecovelo-sdk-release.aar \
             ecovelo-sdk/build/outputs/aar/ecovelo-sdk-${{ steps.version.outputs.VERSION }}.aar

      - name: Generate changelog
        id: changelog
        run: |
          # Récupère le tag précédent
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "CHANGELOG=Initial release" >> $GITHUB_OUTPUT
          else
            # Génère le changelog depuis le dernier tag
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -50)
            # Escape pour GitHub Actions
            CHANGELOG="${CHANGELOG//'%'/'%25'}"
            CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
            CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
            echo "CHANGELOG=${CHANGELOG}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Ecovelo SDK Android v${{ steps.version.outputs.VERSION }}
            
            ### Installation via JitPack
            
            ```gradle
            // settings.gradle.kts
            dependencyResolutionManagement {
                repositories {
                    maven { url = uri("https://jitpack.io") }
                }
            }
            
            // build.gradle.kts
            dependencies {
                implementation("com.github.titibike:ecovelo-sdk-android:${{ steps.version.outputs.VERSION }}")
            }
            ```
            
            ### Changelog
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### Assets
            - `ecovelo-sdk-${{ steps.version.outputs.VERSION }}.aar` - SDK compilé (téléchargement direct)
            
          files: |
            ecovelo-sdk/build/outputs/aar/ecovelo-sdk-${{ steps.version.outputs.VERSION }}.aar
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger JitPack build (optional)
        run: |
          # JitPack va automatiquement détecter le nouveau tag
          # Cette requête est optionnelle et sert juste à pré-chauffer le cache
          curl -s "https://jitpack.io/api/builds/com.github.titibike/ecovelo-sdk-android/${{ steps.version.outputs.VERSION }}" || true
        continue-on-error: true
